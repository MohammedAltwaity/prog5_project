<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prime Challenge</title>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --glass: rgba(255, 255, 255, 0.16);
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px 20px;
            box-sizing: border-box;
        }
        .box {
            width: min(520px, 100%);
            background: var(--glass);
            padding: 40px 32px;
            border-radius: 28px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
        }
        h1 {
            margin: 0 0 18px;
            font-size: clamp(32px, 6vw, 48px);
            line-height: 1.1;
        }
        input {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            font-size: 18px;
            border: none;
            border-radius: 14px;
            outline: none;
            box-sizing: border-box;
        }
        button {
            flex: 1;
            padding: 16px;
            font-size: 18px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .actions {
            display: flex;
            gap: 12px;
            margin: 20px 0 10px;
        }
        .reg {background: #27ae60; color: white;}
        .login {background: #3498db; color: white;}
        button:hover {transform: translateY(-2px); opacity: 0.93;}

        #status {font-size: 28px; font-weight: bold; margin: 26px 0 10px; min-height: 42px;}
        .your-turn {color: #51cf66; animation: pulse 1.5s infinite;}
        @keyframes pulse {0%,100%{transform:scale(1)} 50%{transform:scale(1.05)}}

        #primes {display: flex; flex-wrap: wrap; justify-content: center;}
        .prime-btn {
            width: 92px; height: 92px; font-size: 34px; margin: 12px;
            border-radius: 22px; background: #4ecdc4; color: white; font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25); border: none;
        }
        .prime-btn:hover:not(:disabled) {background: #45b7aa; transform: translateY(-4px);}
        .prime-btn:disabled {background: #95a5a6; opacity: 0.5; cursor: not-allowed;}

        .room-info {background: rgba(255,255,255,0.25); padding: 18px; border-radius: 18px; margin: 18px 0; font-size: 18px;}
        .error {background: #e74c3c; padding: 14px; border-radius: 12px; margin: 12px 0; display: none;}
        .hidden {display: none !important;}

        .game-over {background: rgba(255,215,0,0.3); padding: 30px; border-radius: 24px; margin: 30px 0; border: 3px solid #ffd700;}
        .game-over h2 {color: #ffd700; font-size: 38px; margin: 14px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);}
        .restart-btn {background: #e67e22; color: white; padding: 18px 40px; font-size: 20px; margin-top: 14px;}
        .restart-btn:hover {background: #d35400; transform: scale(1.05);}

        @media (max-width: 640px) {
            body {padding: 20px;}
            .box {padding: 28px 22px; border-radius: 22px;}
            h1 {font-size: 34px;}
            .actions {flex-direction: column;}
            button {width: 100%;}
            .prime-btn {width: 80px; height: 80px; font-size: 30px;}
            #status {font-size: 24px;}
        }
        @media (max-width: 400px) {
            .box {padding: 24px 18px;}
            input {font-size: 16px;}
            button {font-size: 16px; padding: 14px;}
            .prime-btn {width: 70px; height: 70px; font-size: 26px; margin: 8px;}
        }
    </style>
</head>
<body>
    <div class="box">
        <h1>Prime Challenge ‚Äì First to 31</h1>

        <div id="auth">
            <h2 style="margin-bottom: 30px;">Welcome to Prime Challenge!</h2>
            <input id="username" placeholder="Username" autocomplete="off"><br>
            <input id="password" type="password" placeholder="Password"><br>
            <div id="errorMsg" class="error"></div>
            <div class="actions">
                <button class="reg" onclick="register()">Register</button>
                <button class="login" onclick="login()">Login</button>
            </div>
            <p style="margin-top: 20px; opacity: 0.8; font-size: 14px;">New user? Register first, then login to play!</p>
        </div>

        <div id="lobby" style="display:none">
            <div id="roomControls">
                <button onclick="createRoom()">Create Room</button><br><br>
                <input id="roomInput" placeholder="Enter Room ID">
                <button onclick="joinRoom()">Join Room</button>
            </div>
            <div id="roomInfo" class="room-info hidden">
                Room Created! Share ID ‚Üí <strong id="roomIdText"></strong>
            </div>
            <h2>Current: <span id="current">0</span> / 31</h2>
            <h3 id="status">Waiting for opponent...</h3>
            <div id="primes"></div>
        </div>
    </div>

    <script>
        // Get server URL from Android injection or use default
        function getServerUrl() {
            if (window.SERVER_URL) {
                return window.SERVER_URL;  // From Android injection
            }
            return window.location.origin || "http://localhost:8000";  // Desktop default
        }
        
        function getWsUrl() {
            if (window.WS_URL) {
                return window.WS_URL;  // From Android injection
            }
            const serverUrl = getServerUrl();
            return serverUrl.replace("http://", "ws://").replace("https://", "wss://");
        }
        
        const SERVER_URL = getServerUrl();
        const WS_URL = getWsUrl();
        
        let ws, username;

        function showError(msg) {
            const el = document.getElementById("errorMsg");
            el.textContent = msg;
            el.style.display = "block";
            setTimeout(() => el.style.display = "none", 4000);
        }

        function showSuccess(msg) {
            const el = document.getElementById("errorMsg");
            el.textContent = msg;
            el.style.background = "#27ae60";
            el.style.display = "block";
            setTimeout(() => {
                el.style.display = "none";
                el.style.background = "#e74c3c";
            }, 3000);
        }

        async function register() {
            const u = document.getElementById("username").value.trim();
            const p = document.getElementById("password").value;
            if (!u || !p) return showError("Fill both fields");
            if (u.length < 3) return showError("Username must be at least 3 characters");
            if (p.length < 3) return showError("Password must be at least 3 characters");

            try {
                const res = await fetch(SERVER_URL + "/register", {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({username: u, password: p})
                });
                if (res.ok) {
                    showSuccess("‚úÖ Registered successfully! Now click Login");
                } else {
                    const data = await res.json();
                    showError(data.detail || "Registration failed");
                }
            } catch { showError("Server error - make sure services are running"); }
        }

        async function login() {
            const u = document.getElementById("username").value.trim();
            const p = document.getElementById("password").value;
            if (!u || !p) return showError("Fill both fields");

            try {
                const res = await fetch(SERVER_URL + "/login", {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({username: u, password: p})
                });
                if (res.ok) {
                    username = u;
                    showSuccess("‚úÖ Login successful! Connecting...");
                    setTimeout(() => {
                        document.getElementById("auth").style.display = "none";
                        document.getElementById("lobby").style.display = "block";
                        ws = new WebSocket(WS_URL + "/ws");
                        ws.onopen = () => {
                            ws.send(JSON.stringify({type: "auth", username: u, password: p}));
                            showSuccess("‚úÖ Connected to game server!");
                        };
                        ws.onmessage = handleMessage;
                        ws.onerror = () => showError("WebSocket connection error");
                    }, 500);
                } else {
                    const data = await res.json();
                    showError(data.detail || "‚ùå Wrong username or password");
                }
            } catch { showError("Cannot connect to server - make sure services are running"); }
        }

        function handleMessage(e) {
            const msg = JSON.parse(e.data);
            if (msg.type === "logged_in") console.log("Logged in as", username);
            if (msg.type === "error") showError("Error: " + msg.message);
            if (msg.type === "room_created") {
                document.getElementById("roomIdText").textContent = msg.room_id;
                document.getElementById("roomInfo").classList.remove("hidden");
                document.getElementById("roomControls").classList.add("hidden");
            }
            if (msg.type === "game_start") {
                document.getElementById("roomControls").classList.add("hidden");
            }
            if (msg.type === "update") {
                document.getElementById("current").textContent = msg.sum;
                const myTurn = msg.turn === username;
                document.getElementById("status").textContent = myTurn ? "YOUR TURN!" : "Waiting for opponent...";
                document.getElementById("status").className = myTurn ? "your-turn" : "";
                showPrimes(msg.sum, myTurn);
            }
            if (msg.type === "game_over") {
                const isWinner = msg.winner === username;
                document.getElementById("status").textContent = isWinner ? "üéâ YOU WIN! üéâ" : "üòî " + msg.winner + " WINS!";
                document.getElementById("status").className = isWinner ? "your-turn" : "";
                document.getElementById("primes").innerHTML = `
                    <div class="game-over">
                        <h2>${isWinner ? "üèÜ VICTORY! üèÜ" : "Game Over"}</h2>
                        <p style="font-size: 24px; margin: 20px;">${isWinner ? "Congratulations! You played brilliantly!" : "Better luck next time!"}</p>
                        <p style="font-size: 18px; opacity: 0.9;">Final Score: <strong>${document.getElementById("current").textContent}</strong> / 31</p>
                        <button class="restart-btn" onclick="restartGame()">üîÑ Play Again</button>
                    </div>
                `;
            }
            if (msg.type === "game_restarted") {
                // Game restarted - UI will be updated by the "update" message that follows
                document.getElementById("roomControls").classList.add("hidden");
            }
        }

        function showPrimes(sum, myTurn) {
            const div = document.getElementById("primes");
            div.innerHTML = "";
            [2,3,5,7,11].forEach(p => {
                if (sum + p <= 31) {
                    const b = document.createElement("button");
                    b.className = "prime-btn";
                    b.textContent = p;
                    b.disabled = !myTurn;
                    b.onclick = () => myTurn && ws.send(JSON.stringify({type: "move", prime: p}));
                    div.appendChild(b);
                }
            });
        }

        function createRoom() { ws.send(JSON.stringify({type: "create_room"})); }
        function joinRoom() {
            const id = document.getElementById("roomInput").value.trim();
            if (id) ws.send(JSON.stringify({type: "join_room", room_id: id}));
        }
        
        function restartGame() {
            // Send restart request to server - server will notify both players
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: "restart_game"}));
            } else {
                showError("Not connected to server");
            }
        }
    </script>
</body>
</html>